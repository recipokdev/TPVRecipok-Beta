#!/usr/bin/env bash
set -e

# ---- 0) Detectar usuario real (cuando instalas con Ubuntu Software no siempre hay SUDO_USER)
REAL_USER="${SUDO_USER:-}"
if [ -z "$REAL_USER" ]; then
  REAL_USER="$(awk -F: '$3>=1000 && $1!="nobody"{print $1; exit}' /etc/passwd)"
fi

REAL_HOME="$(getent passwd "$REAL_USER" | cut -d: -f6)"
if [ -z "$REAL_HOME" ] || [ ! -d "$REAL_HOME" ]; then
  exit 0
fi

# ---- 1) Dependencias (FUSE + curl)
apt-get update || true
apt-get install -y curl ca-certificates libfuse2 fuse cups cups-client || true

# ---- 2) Regla udev del cajón/impresora
RULE_DST="/etc/udev/rules.d/99-tpvrecipok-cashdrawer.rules"

if [ -f "/opt/TPV Recipok/resources/assets/udev/99-tpvrecipok-cashdrawer.rules" ]; then
  cp -f "/opt/TPV Recipok/resources/assets/udev/99-tpvrecipok-cashdrawer.rules" "$RULE_DST"
  chmod 644 "$RULE_DST"
fi

if command -v udevadm >/dev/null 2>&1; then
  udevadm control --reload-rules || true
  udevadm trigger || true
fi

# ---- 3) Instalar icono del sistema (evita el engranaje)
ICON_SYS_DIR="/usr/share/icons/hicolor/256x256/apps"
ICON_SYS_PATH="$ICON_SYS_DIR/tpvrecipok.png"
mkdir -p "$ICON_SYS_DIR"

if [ -f "/opt/TPV Recipok/resources/assets/icon.png" ]; then
  cp -f "/opt/TPV Recipok/resources/assets/icon.png" "$ICON_SYS_PATH" || true
  chmod 644 "$ICON_SYS_PATH" || true
fi

if command -v gtk-update-icon-cache >/dev/null 2>&1; then
  gtk-update-icon-cache -f /usr/share/icons/hicolor || true
fi

# ---- 4) Descargar AppImage latest (1 solo icono visible para el usuario)
APP_DIR="$REAL_HOME/.local/share/tpvrecipok"
APPIMAGE_PATH="$APP_DIR/TPV-Recipok.AppImage"
mkdir -p "$APP_DIR"

APPIMAGE_URL="https://github.com/recipokdev/TPVRecipok/releases/latest/download/TPV-Recipok.AppImage"

TMP="$(mktemp)"
if curl -L --fail -o "$TMP" "$APPIMAGE_URL"; then
  mv "$TMP" "$APPIMAGE_PATH"
  chmod +x "$APPIMAGE_PATH"
  chown -R "$REAL_USER:$REAL_USER" "$APP_DIR"
else
  rm -f "$TMP" || true
fi

# ---- 5) Desktop entry (menú del sistema) apuntando al AppImage
DESKTOP_ENTRY="/usr/share/applications/tpvrecipok.desktop"
cat > "$DESKTOP_ENTRY" <<EOF
[Desktop Entry]
Name=TPV Recipok
Comment=Terminal punto de venta
Exec="${APPIMAGE_PATH}"
Icon=tpvrecipok
Terminal=false
Type=Application
Categories=Office;
StartupNotify=false
EOF
chmod 644 "$DESKTOP_ENTRY" || true

# ---- 6) Acceso directo en Escritorio (solo 1 cosa visible)
DESK1="$REAL_HOME/Escritorio"
DESK2="$REAL_HOME/Desktop"
TARGET_DESK=""

if [ -d "$DESK1" ]; then TARGET_DESK="$DESK1"; fi
if [ -z "$TARGET_DESK" ] && [ -d "$DESK2" ]; then TARGET_DESK="$DESK2"; fi

if [ -n "$TARGET_DESK" ]; then
  DESK_FILE="$TARGET_DESK/TPV-Recipok.desktop"
  cat > "$DESK_FILE" <<EOF
[Desktop Entry]
Type=Application
Name=TPV Recipok
Comment=Terminal punto de venta
Exec="${APPIMAGE_PATH}"
Icon=tpvrecipok
Terminal=false
Categories=Office;
StartupNotify=false
EOF

  chown "$REAL_USER:$REAL_USER" "$DESK_FILE" || true
  chmod 755 "$DESK_FILE" || true

  # marcar como confiable si es posible
  if command -v gio >/dev/null 2>&1; then
    sudo -u "$REAL_USER" gio set "$DESK_FILE" metadata::trusted true 2>/dev/null || true
  fi
fi

# ---- 7) Autoarranque (al iniciar sesión)
AUTOSTART_DIR="$REAL_HOME/.config/autostart"
mkdir -p "$AUTOSTART_DIR"

cat > "$AUTOSTART_DIR/tpvrecipok.desktop" <<EOF
[Desktop Entry]
Type=Application
Name=TPV Recipok
Exec="${APPIMAGE_PATH}"
Icon=tpvrecipok
X-GNOME-Autostart-enabled=true
Terminal=false
EOF

chown "$REAL_USER:$REAL_USER" "$AUTOSTART_DIR/tpvrecipok.desktop" || true
chmod 644 "$AUTOSTART_DIR/tpvrecipok.desktop" || true

exit 0
